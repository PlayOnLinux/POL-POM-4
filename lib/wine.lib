#!/bin/bash

# Copyright (C) 2007-2012 PlayOnLinux Team
# Copyright (C) 2007 PÃ¢ris Quentin

# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.

# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.

# You should have received a copy of the GNU General Public License along
# with this program; if not, write to the Free Software Foundation, Inc.,
# 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA. 

# wine.lib
# --------
#
# This lib contains wine's api

POL_Wine_GetRegValue()
{
	# Get a value in registry
	# Example : POL_Wine_GetReg_Value Multisampling
	#
	# Read http://wiki.winehq.org/UsefulRegistryKeys

	[ -z "$WINEPREFIX" ] && POL_Debug_Fatal "WINEPREFIX not set"
	local value
	[ -e "$WINEPREFIX/user.reg" ] && value="$(grep "$1" "$WINEPREFIX/user.reg" | head -n 1 | tr -d '"' | cut -d= -f2)"
	POL_Debug_Message "Getting registry value $1. Return: $value"
	echo -n "${value:-default}"
}

POL_Wine_UpdateRegistry ()
{
	# Usage: POL_Wine_UpdateRegistry regbasename
	# registry file must be provided thru stdin
	# File signature ("REGEDIT4") in appended automatically

	(echo "REGEDIT4"; echo ""; cat) > "$POL_USER_ROOT/tmp/$1.reg"
	POL_Wine regedit "$POL_USER_ROOT/tmp/$1.reg" &&
	rm "$POL_USER_ROOT/tmp/$1.reg"
}

POL_Wine_UpdateRegistryPair ()
{
	# Usage: POL_Wine_UpdateRegistryPair key name data
	# data="default": remove the name
	# Remark: restarts wineserver

	if [ "$3" = "default" ]; then
		POL_Wine_UpdateRegistry regkey <<- _EOFINI_
		[$1]
		"$2"=-
		_EOFINI_
	else
		POL_Wine_UpdateRegistry regkey <<- _EOFINI_
		[$1]
		"$2"="$3"
		_EOFINI_
	fi
}

POL_Wine_UpdateRegistryWinePair ()
{
	# Usage: POL_Wine_UpdateRegistryPair subkey name data
	# data="default": remove the name
	# Remark: restarts wineserver

	# Put a "\" before $1 if it's not empty
	POL_Wine_UpdateRegistryPair "HKEY_CURRENT_USER\\Software\\Wine${1:+\\$1}" "$2" "$3"
}

# For all functions below, that can be called from the control panel:
# - Kill wineserver before regedit so regedit works even if the user
#   changed Wine version out of our control;
# - Kill wineserver after regedit so change takes effect immediately

POL_Wine_Direct3D ()
{
	# Change a Direct3D value in registry
	# Usage POL_Wine_Direct3D Key Value

	# Example :: POL_Wine_Direct3D UseGLSL [default / enabled / disabled]
	# default: remove the key
	POL_Debug_Message "Setting wine Direct3D $WINEPREFIX $1 $2"
	[ -z "$WINEPREFIX" ] && POL_Debug_Fatal "WINEPREFIX not set"

	wineserver -k
	POL_Wine_UpdateRegistryWinePair 'Direct3D' "$1" "$2"
	wineserver -k
}

POL_Wine_X11Drv ()
{
	# Change a X11Drv value in registry
	# Usage POL_Wine_X11Drv Key Value

	# Example :: POL_Wine_X11Drv UseGLSL [default / enabled / disabled]
	# default: remove the key
	POL_Debug_Message "Setting wine X11Drv $WINEPREFIX $1 $2"
	[ -z "$WINEPREFIX" ] && POL_Debug_Fatal "WINEPREFIX not set"

	wineserver -k
	POL_Wine_UpdateRegistryWinePair 'X11 Driver' "$1" "$2"
	wineserver -k
}

POL_Wine_DirectSound ()
{
	# Same that POL_Wine_Direct3D, but for DirectSound
	POL_Debug_Message "Setting wine DirectSound $WINEPREFIX $1 $2"
	[ -z "$WINEPREFIX" ] && POL_Debug_Fatal "WINEPREFIX not set"

	wineserver -k
	POL_Wine_UpdateRegistryWinePair 'DirectSound' "$1" "$2"
	wineserver -k
}

POL_Wine_DirectInput ()
{
	# Same that POL_Wine_Direct3D, but for DirectInput
	POL_Debug_Message "Setting wine DirectInput $WINEPREFIX $1 $2"
	[ -z "$WINEPREFIX" ] && POL_Debug_Fatal "WINEPREFIX not set"

	wineserver -k
	POL_Wine_UpdateRegistryWinePair 'DirectInput' "$1" "$2"
	wineserver -k
}

Set_OS ()
{
	# Set fake windows OS
	# Usage: Set_OS [1] [2]
	#
	# 1: Possible values: win7, win2008, vista, win2003, winxp, win2000, nt40, winnt351, winme, win98, win95, win31, win30, win20
	# 2: Service Pack: sp1, sp2, sp3, sp4, sp5
	POL_Debug_Message "Setting Windows OS to $1 $2"
	[ -z "$WINEPREFIX" ] && POL_Debug_Fatal "WINEPREFIX not set"

	if [ -n "$1" ]; then
		POL_Wine_UpdateRegistryWinePair '' 'Version' "$1"
	fi

	if [ -n "$2" ]; then # Need more testing
		local n
		[ "$2" = "sp1" ] && n=1
		[ "$2" = "sp2" ] && n=2
		[ "$2" = "sp3" ] && n=3
		[ "$2" = "sp4" ] && n=4
		[ "$2" = "sp5" ] && n=5

		POL_Wine_UpdateRegistry setos <<- _EOFINI_
		[HKEY_LOCAL_MACHINE\\Software\\Microsoft\\Windows NT\\CurrentVersion]
		"CSDVersion"="Service Pack $n"
		[HKEY_LOCAL_MACHINE\\System\\CurrentControlSet\\Control\\Windows]
		"CSDVersion"=dword:00000${n}00
		_EOFINI_
	fi
}

Set_Managed ()
{
	# Let the windows manager to control wine
	# Usage: Set_Managed (On|Off)

	POL_Debug_Message "Setting wine managed: $1"
	[ -z "$WINEPREFIX" ] && POL_Debug_Fatal "WINEPREFIX not set"

	local n
	[ "$1" = "On" ] && n="Y"
	[ "$1" = "Off" ] && n="N"
	if [ -n "$n" ]; then
		POL_Wine_UpdateRegistryWinePair 'X11 Driver' "Managed" "$n"
	else
		POL_Debug_Warning "Unrecognized flag '$1'"
	fi
}

Set_SoundDriver ()
{
	# Set the sound driver
	# Usage: Set_SoundDriver [Driver]
	# Disabled in Mac OS
	POL_Debug_Message "Setting wine SoundDriver $@"
	[ -z "$WINEPREFIX" ] && POL_Debug_Fatal "WINEPREFIX not set"

	if [ -n "$1" ]; then
		if [ "$POL_OS" = "Linux" ]; then
			POL_Wine_UpdateRegistryWinePair 'Drivers' 'Audio' "$1"
		else
			POL_Debug_Message "Set_SoundDriver disabled on $POL_OS"
		fi
	fi
}

Set_DXGrab ()
{
	# Enable or disable DXGrab
	# Usage: Set_DXGrab (On|Off)
	# On ou Off
	[ -z "$WINEPREFIX" ] && POL_Debug_Fatal "WINEPREFIX not set"

	local n
	[ "$1" = "On" ] && n="Y" && POL_Debug_Message "Setting DXGrab"
	[ "$1" = "Off" ] && n="N" && POL_Debug_Message "Unsetting DXGrab"
	if [ -n "$n" ]; then
		POL_Wine_UpdateRegistryWinePair 'X11 Driver' 'DXGrab' "$n"
	else
		POL_Debug_Warning "Set_DXGrab: unrecognized flag '$1'"
	fi
}

Set_Iexplore ()
{
	# Make a fake IE6 installation
	# Usage: Set_Iexplore
	POL_Debug_Message "Faking ie6 installation"
	[ -z "$WINEPREFIX" ] && POL_Debug_Fatal "WINEPREFIX not set"

	POL_Wine_UpdateRegistry ie <<- _EOFINI_
	[HKEY_LOCAL_MACHINE\\Software\\Microsoft\\Internet Explorer]
	"Version"="6.0.2900.2180"
	_EOFINI_
}

Set_Desktop ()
{
	# Set a desktop environement
	# Usage: Set_Desktop (on|off) [width] [height]

	POL_Debug_Message "Setting Desktop : $1 $2 $3"
	[ -z "$WINEPREFIX" ] && POL_Debug_Fatal "WINEPREFIX not set"

	local n
	[ "$1" = "On" ] && n="$2x$3"
	[ "$1" = "Off" ] && n="-1"
	if [ -n "$n" ]; then
		POL_Wine_UpdateRegistryWinePair 'X11 Driver' 'Desktop' "$n"
	else
		POL_Debug_Warning "Unrecognized flag '$1'"
	fi
}

Set_SoundSampleRate ()
{
	# Set Sound sample rate
	# Usage: Set_SoundSampleRate [value]
	# values can be: 48000, 44100, 22050, 16000, 11025, 8000
	POL_Debug_Message "Setting SoundSampleRate to $1"
	[ -z "$WINEPREFIX" ] && POL_Debug_Fatal "WINEPREFIX not set"

	if [ -n "$1" ]; then
		POL_Wine_UpdateRegistryWinePair 'DirectSound' 'DefaultSampleRate' "$1"
	else
		# FIXME: should we drop the name instead?
		POL_Debug_Warning "Sample rate missing, skipped"
	fi
}

Set_SoundBitsPerSample ()
{
	# Set Sound bits per sample rate
	# Usage: Set_SoundBitsPerSaple [value]
	# values: 8, 16
	POL_Debug_Message "Setting sound DefaultsBitsPerSample to $1"
	[ -z "$WINEPREFIX" ] && POL_Debug_Fatal "WINEPREFIX not set"

	if [ -n "$1" ]; then
		POL_Wine_UpdateRegistryWinePair 'DirectSound' 'DefaultBitsPerSample' "$1"
	else
		# FIXME: should we drop the name instead?
		POL_Debug_Warning "BitsPerSample missing, skipped"
	fi
}

POL_Wine_InstallFonts()
{
	# Install microsoft fonts
	# Usage: POL_Wine_InstallFonts
	OLDDIR="$PWD"
	POL_Debug_Message "Installing microsoft fonts"
	[ -z "$WINEPREFIX" ] && POL_Debug_Fatal "WINEPREFIX not set"

	# It's a symlink? If yes, remove it
	rm "$WINEPREFIX/drive_c/windows/Fonts" 2> /dev/null
	mkdir -p "$WINEPREFIX/drive_c/windows/Fonts"

	cp "$POL_USER_ROOT/fonts/"* "$WINEPREFIX/drive_c/windows/Fonts/"
}

Set_SoundHardwareAcceleration ()
{
	# Set sound driver hardware acceleration
	# Values : Full, Standard, Basic, Emulation
	POL_Debug_Message "Setting Sound HardwareAcceleration to $1"
	[ -z "$WINEPREFIX" ] && POL_Debug_Fatal "WINEPREFIX not set"

	if [ -n "$1" ]; then
		POL_Wine_UpdateRegistryWinePair 'DirectSound' 'HardwareAcceleration' "$1"
	else
		# FIXME: should we drop the name instead?
		POL_Debug_Warning "Hardware acceleration mode missing, skipped"
	fi
}

Set_SoundEmulDriver ()
{
	# Set sound emul driver
	# Usage: Set_SoundEmulDriver(Y|N)
	POL_Debug_Message "Setting Sound EmulDriver to $1"
	[ -z "$WINEPREFIX" ] && POL_Debug_Fatal "WINEPREFIX not set"

	if [ -n "$1" ]; then
		POL_Wine_UpdateRegistryWinePair 'DirectSound' 'EmulDriver' "$1"
	else
		# FIXME: should we drop the name instead?
		POL_Debug_Warning "Sound emulation mode missing, skipped"
	fi
}

POL_LoadVar_PROGRAMFILES()
{
	# Get Program Files folder name and store it to PROGRAMFILES variable
	# Usage: POL_LoadVar_PROGRAMFILES
	POL_Debug_Message "Getting Program Files name"
	[ -z "$WINEPREFIX" ] && POL_Debug_Fatal "WINEPREFIX not set"

	PROGRAMFILES=`POL_Wine --keep-output cmd /c echo "%ProgramFiles%" |tr -d '\015\012'`
	if [ "${PROGRAMFILES}" = "%ProgramFiles%" ]
	then # Var is not defined by wine
		export PROGRAMFILES="Program Files"
	else
		export PROGRAMFILES="${PROGRAMFILES:3}"
	fi
}

Set_WineWindowTitle ()
{
	#name of windowed title:$1
	POL_Debug_Message "Setting window title"
	[ -z "$WINEPREFIX" ] && POL_Debug_Fatal "WINEPREFIX not set"

	POL_Wine_UpdateRegistryWinePair 'Explorer' 'Desktop' "$1"
}

POL_LoadVar_Device ()
{
	# Get GPU device id and vendor id
	# Results are stored in VendorID and DeviceID variables

	POL_Debug_Message "Gettings GPU informations"
	if [ "$POL_OS" = "Linux" ]; then
		[ -x /usr/sbin/lspci ] && LSPCI=/usr/sbin/lspci || LSPCI=lspci
		VGA_ID1=`$LSPCI | grep -iE "nvidia|ATI|AMD|intel" | grep VGA | awk '{ print $1 }' | head -n 1`
		VGA_ID2=`$LSPCI -n | grep $VGA_ID1 | awk '{ print $3 }'`
		export VendorID=`echo $VGA_ID2 | cut -d: -f1`
		export DeviceID=`echo $VGA_ID2 | cut -d: -f2`
	fi
	if [ "$POL_OS" = "Mac" ]; then
		export DeviceID="$(system_profiler | grep -A 10 "Graphics/Displays:" | grep "Device ID" | awk '{print $3}' | cut -d x -f2)"
		export VendorID="$(system_profiler | grep -A 10 "Graphics/Displays:" | grep "Vendor:" | awk '{print $3}' | tr -d "()" | cut -d x -f2)"
	fi
	POL_Debug_Message "VendorID : $VendorID"
	POL_Debug_Message "DeviceID : $DeviceID"
}

POL_LoadVar_ScreenResolution ()
{
	if [ "$POL_OS" = "Linux" ]; then
		local RESOLUTION="$(xdpyinfo | grep dimensions | awk '{print $2}')"
		export ScreenWidth="$(echo $RESOLUTION | cut -dx -f1)"
		export ScreenHeight="$(echo $RESOLUTION | cut -dx -f2)"
	fi
	if [ "$POL_OS" = "Mac" ]; then
		export ScreenWidth="$(/usr/sbin/system_profiler SPDisplaysDataType | grep Resolution| awk '{print $2}')"
		export ScreenHeight="$(/usr/sbin/system_profiler SPDisplaysDataType | grep Resolution| awk '{print $4}')"
	fi
	POL_Debug_Message "Screen width: $ScreenWidth"
	POL_Debug_Message "Screen height: $ScreenHeight"
}

POL_Wine_SetVideoDriver()
{
	# Set wine video driver
	# Usage POL_Wine_SetVideoDriver
	POL_Debug_Message "Set wine video driver"
	[ -z "$WINEPREFIX" ] && POL_Debug_Fatal "WINEPREFIX not set"

	POL_LoadVar_Device
	DRVID="vga.dll"
	[ "$VendorID" = "10de" ] && DRVID="nv4_disp.dll"
	[ "$VendorID" = "1002" ] && DRVID="ati2dvag.dll"
	[ "$VendorID" = "8086" ] && DRVID="ig4icd32.dll"
	POL_Debug_Message "Detected video driver: $DRVID"

	POL_Wine_UpdateRegistry VGA_ID_fix <<- _EOFINI_
	[HKEY_CURRENT_USER\\Software\\Wine\\Direct3D]
	"VideoPCIVendorID"="dword:0000$VendorID"
	"VideoPCIDeviceID"="dword:0000$DeviceID"
	"VideoDriver"="$DRVID"
	_EOFINI_
}

POL_AutoWine ()
{
	# Detect if the file is a .exe or a .msi file and run it with POL_Wine
	# Same usage than "wine"
	SETUP_PATH="$@"
	# remove everything up to the last dot
	extension="${SETUP_PATH##*.}"
	if [ "$extension" = "msi" ]
	then
		POL_Wine msiexec /i "$SETUP_PATH"
	else
		# FIXME /unix?
		POL_Wine "$SETUP_PATH"
	fi
}

POL_Wine ()
{
	# Run the good wineversion and store the result to a logfile
	# Same usage than "wine"
	local KeepOutput NoErrors
	if [ "$1" = "--keep-output" ]; then
		KeepOutput="True"
		shift
	fi
	if [ "$1" = "--ignore-errors" ]; then
		NoErrors="True"
		shift
	fi
	POL_Wine_AutoSetVersionEnv
	POL_Debug_Message "Running wine-$POL_WINEVERSION "$@" "

	if [ "$LOGFILE" = "/dev/null" -o "$KeepOutput" = "True" ]; then
		wine "$@"
	else
		wine "$@" >> "$LOGFILE" 2>&1
	fi
	errors=$?
	if [ $errors != 0 -a "$NoErrors" != "True" ]; then
		POL_Debug_Error "$(eval_gettext 'Wine seems to have crashed\n\nIf your program is running, just ignore this message')"
	fi
	POL_Debug_Message "Wine return: $errors"
	return $errors
}

POL_Wine_SelectPrefix()
{
	# Select a wineprefix and remove unexpected chars
	# Usage: POL_Wine_SelectPrefix [prefixname]
	PREFNAME=`printf "$1"| tr -c [[a-zA-Z0-9]\.] '_'`
	POL_Debug_Message "Selecting prefix: $PREFIXNAME"
	export WINEPREFIX="$POL_USER_ROOT/wineprefix/$PREFNAME"
	export DOSPREFIX="$WINEPREFIX"
	export POL_WINEVERSION="$(POL_Config_PrefixRead VERSION)"
	touch "$WINEPREFIX/playonlinux.cfg" 2> /dev/null
}
POL_Wine_PrefixExists()
{
	# Checks if a prefix exists
	# Usage: POL_Wine_PrefixExists
	# Return True or False
	PREFNAME=`printf "$1"| tr -c [[a-zA-Z0-9]\.] '_'`
	[ -d "$POL_USER_ROOT/wineprefix/$PREFNAME/drive_c" ] && echo "True" || echo "False"
}
POL_Wine_InstallVersion()
{
	# Install a wineverison
	# Usage: POL_Wine_InstallVersion [VERSION]
	[ ! "$1" = "" ] && export POL_WINEVERSION="$1"
	[ "$POL_WINEVERSION" = "" ] && POL_Debug_Fatal "No POL_WINEVERSION set"
	[ "$POL_ARCH" = "" ] && POL_System_SetArch "auto"
	POL_Debug_Message "Installing wine version path: $POL_WINEVERSION, $POL_ARCH"
	[ "$POL_OS" = "Mac" ] && ARCH_PREFIX="darwin"
	[ "$POL_OS" = "Linux" ] && ARCH_PREFIX="linux"
	OLDPATH="$PWD"
	WINE_SECTION="$ARCH_PREFIX-$POL_ARCH"
	WINEDIR="$REPERTOIRE/wine/$WINE_SECTION"
	touch "$WINEDIR/installing"
	if [ ! -e "$WINEDIR/$POL_WINEVERSION" ]
	then
		
		WINE_ADDRESS=$(wget -4 "$WINE_SITE/$WINE_SECTION.lst" -O- | grep ";$POL_WINEVERSION;" | tail -n 1 | cut -d ";" -f1)
		if [ "$WINE_ADDRESS" = "" ] && [ "$POL_ARCH" = "amd64" ]
		then
			POL_Debug_Warning "Wine $1 amd64 does not exist. Switching to x86"
			POL_System_SetArch "x86"
			POL_Wine_InstallVersion "$1"
		else
			if [ "$WINE_ADDRESS" = "" ]
			then
				POL_Debug_Error "$(eval_gettext "Unable to find version: ")$POL_WINEVERSION"
				POL_SetupWindow_Close
				exit
			fi

			cd "$REPERTOIRE/tmp"
			POL_SetupWindow_download "$(eval_gettext "Downloading Wine: ")$POL_WINEVERSION" "Wine" "$WINE_SITE/$WINE_SECTION/$WINE_ADDRESS"
			POL_SetupWindow_wait_next_signal "$(eval_gettext "Downloading Wine: ")$POL_WINEVERSION" "Wine"
			sleep 1
			sha1=$(wget -4 "$WINE_SITE/$WINE_SECTION/$WINE_ADDRESS.sha1" -O- | awk '{print $1}')
			sha1_file=$(shasum "./$WINE_ADDRESS" | awk '{print $1}')
			echo "Server sha1 : $sha1"
			echo "Client sha1 : $sha1_file"

			if [ ! "$sha1" = "$sha1_file" ]
			then
				POL_SetupWindow_message "$(eval_gettext 'The download seems to have failed.')" "Wine $POL_WINEVERSION"
			else
				POL_SetupWindow_wait "$(eval_gettext 'Extracting Wine...')" "Wine $POL_WINEVERSION"
				"$PLAYONLINUX/playonlinux-pkg" -i "$PWD/$WINE_ADDRESS"
			fi
			rm "$WINE_ADDRESS"
		fi
	fi
	rm "$WINEDIR/installing"
	
}
POL_Wine_AutoSetVersionEnv()
{
	# Get the current prefix's version and set PATH environement variable
	# Usage: POL_Wine_AutoSetVersionEnv
	[ "$WINEPREFIX" = "" ] && POL_Debug_Fatal "WINEPREFIX is not set!"
	POL_WINEVERSION="$(POL_Config_PrefixRead "VERSION")"
	POL_ARCH="$(POL_Config_PrefixRead "ARCH")"
	[ "$POL_WINEVERSION" = "" ] || POL_Wine_SetVersionEnv
}
POL_Wine_SetVersionEnv()
{
	# Usage: POL_Wine_SetWineVersion [VERSION]
	# Get first argument's wine version and set PATH environement variable
	[ ! "$1" = "" ] && export POL_WINEVERSION="$1"
	[ "$POL_WINEVERSION" = "" ] && POL_Debug_Warning "No POL_WINEVERSION set, assuming it is reset"
	[ "$POL_WINEVERSION" = "" ] && export POL_WINEVERSION="--reset"
	if [ ! "$POL_WINEVERSION" = "" ]
	then
		[ "$POL_ARCH" = "" ] && POL_System_SetArch "auto"
		POL_Debug_Message "Setting wine version path: $POL_WINEVERSION, $POL_ARCH"
		[ "$POL_OS" = "Mac" ] && ARCH_PREFIX="darwin"
		[ "$POL_OS" = "Linux" ] && ARCH_PREFIX="linux"
		OLDPATH="$PWD"
		WINEDIR="$REPERTOIRE/wine/$ARCH_PREFIX-$POL_ARCH"
		mkdir -p "$WINEDIR"
		cd "$WINEDIR"

		if [ "$POL_WINEVERSION" = "--reset" ]
		then
			export PATH="$PATH_ORIGIN"
			export LD_LIBRARY_PATH="$LD_PATH_ORIGIN"
			export POL_WINEVERSION=""
		else
			if [ ! -e "$WINEDIR/$POL_WINEVERSION" ]
			then
				POL_Debug_Message "Wine $POL_WINEVERSION not installed"
		 		POL_Wine_InstallVersion "$POL_WINEVERSION"
			else
				POL_Debug_Message "\"$WINEDIR/$POL_WINEVERSION\" exists"
			fi
			export PATH="$WINEDIR/$POL_WINEVERSION/bin/:$PATH"
			export LD_LIBRARY_PATH="$WINEDIR/$POL_WINEVERSION/lib/:$LD_LIBRARY_PATH"
		
		fi
	fi
	cd "$OLDPATH"
}
POL_Wine_SetVersionPrefix()
{
	# Usage: POL_Wine_SetVersionPrefix [VERSION]
	# Change a prefix wine version
	[ ! "$1" = "" ] && export POL_WINEVERSION="$1"
	[ "$WINEPREFIX" = "" ] && POL_Debug_Fatal "WINEPREFIX is not set!"

	POL_Config_PrefixWrite "VERSION" "$POL_WINEVERSION"	
}
POL_Wine_PrefixCreate()
{
	# Create a wineprefix
	# Usage: POL_Wine_PrefixCreate [VERSION]
	POL_Debug_Message "Creating prefix ($1)..."
	POL_SetupWindow_wait "$(eval_gettext 'Please wait while the virtual drive is being created...')" "$TITLE"
	[ "$POL_ARCH" = "" ] && POL_System_SetArch "auto"
	[ "$WINEPREFIX" = "" ] && POL_Debug_Fatal "WINEPREFIX is not set!"
	if [ -e "$WINEPREFIX" ]
	then
		POL_Debug_Message "Prefix already exists"
		touch "$WINEPREFIX/playonlinux.cfg"
		[ ! "$1" = "" ] && export POL_WINEVERSION="$1"
		if [ ! "$POL_WINEVERSION" = "" ]
		then
			POL_Debug_Message "Setting version to $POL_WINEVERSION"
			POL_Wine_SetVersionPrefix "$POL_WINEVERSION"
			POL_Wine_SetVersionEnv
		fi
	else
		[ ! "$1" = "" ] && export POL_WINEVERSION="$1"
		if [ "$POL_WINEVERSION" = "" ]
		then
			POL_Debug_Message "No version specified. Using system version ($(wine --version))"
			wine wineboot
			if [ -e "$WINEPREFIX/drive_c/windows/syswow64" ] # It is a 64 bits prefix
			then
				POL_Config_PrefixWrite "ARCH" "amd64"
			else
				POL_Config_PrefixWrite "ARCH" "x86"
			fi
			POL_LoadVar_PROGRAMFILES
		else
			mkdir -p "$WINEPREFIX"
			POL_Debug_Message "Using wine $POL_WINEVERSION"
			POL_Wine_InstallVersion "$POL_WINEVERSION"
			POL_Config_PrefixWrite "ARCH" "$POL_ARCH"
			POL_Config_PrefixWrite "VERSION" "$POL_WINEVERSION"
			which wineprefixcreate && [ "$(POL_MD5_file "$(which wineprefixcreate)")" != "5c0ee90682746e811698a53415b4765d" ] && POL_Wine wineprefixcreate
			POL_Wine wineboot
			POL_LoadVar_PROGRAMFILES
		fi
	fi
	sleep 3 # We wait 3 seconds, so that we are sure that .reg file are created
	POL_LoadVar_PROGRAMFILES
}
POL_Wine_OverrideDLL()
{
	# Override DLLs
	mode=$1
	[ "$mode" = "disabled" ] && unset mode
	shift
 
	cat << EOF > "$POL_USER_ROOT/tmp/override-dll.reg"
REGEDIT4
 
[HKEY_CURRENT_USER\\Software\\Wine\\DllOverrides]
EOF
 
	while test "$1" != ""
	do
		echo "\"*$1\"=\"$mode\"" >> "$POL_USER_ROOT/tmp/override-dll.reg"
		shift
	done
 
	POL_Debug_Message "Overriting DLLs"
	POL_SetupWindow_wait_next_signal "Please wait" "$TITLE"
	POL_Wine regedit "$POL_USER_ROOT/tmp/override-dll.reg"
}

POL_Wine_OverrideDLL_App()
{
	APP="$1"
	MODE="$2"
	DLL="$3"

	cd "$POL_USER_ROOT/ressources"
	[ -e "$POL_USER_ROOT/ressources/app_dll_override.reg" ] && rm app_dll_override.reg

	echo "REGEDIT4" > app_dll_override.reg
	echo "" >> app_dll_override.reg
	echo "[HKEY_CURRENT_USER\\Software\\Wine\\AppDefaults\\$APP\\DllOverrides]" >> app_dll_override.reg
	until [ "$DLL" == "" ]; do
		if [ "$DLL" = "comctl32" ]; then
			rm -rf "$WINEPREFIX/winsxs/manifests/x86_microsoft.windows.common-controls_6595b64144ccf1df_6.0.2600.2982_none_deadbeef.manifest"
		fi
		echo "\"$DLL\"=\"$MODE\"" >> app_dll_override.reg
		shift
		DLL="$3"
	done
	regedit app_dll_override.reg
	rm app_dll_override.reg
}
POL_Wine_WaitBefore ()
{
	SOFTNAME="$1"
	if [ "$1" = "--allow-kill" ] 
	then
		allowKill="true"
		shift
	else
		allowKill="false"
	fi
	
	[ "$1" = "" ] && message="$(eval_gettext "Please wait...")" || message="$(eval_gettext 'Please wait while $SOFTNAME is installed...')"
	
	if [ "$allowKill" = "true" ]
	then
		POL_SetupWindow_wait_button "$message" "$TITLE" "$(eval_gettext 'Install is done')" "wineserver -k" "$(eval_gettext 'Be careful! This will kill install process. If it is not finished, you will have to reinstall $SOFTNAME')"
	else
		POL_SetupWindow_wait "$message" "$TITLE"
	fi
	
}
POL_Wine_WaitExit ()
{
	# Lock bash commands until wine is exited
	if [ "$1" = "--force-input" ] 
	then
		forceInput="true"
		shift
	else
		forceInput="false"
	fi
	if [ "$1" = "--allow-kill" ] 
	then
		allowKill="true"
		shift
	else
		allowKill="false"
	fi
	SOFTNAME="$1"
	[ "$1" = "" ] && message="$(eval_gettext "Please wait...")" || message="$(eval_gettext 'Please wait while $SOFTNAME is installed...')"
	if [ "$allowKill" = "true" ]
	then
		POL_SetupWindow_wait_button "$message" "$TITLE" "$(eval_gettext 'Install is done')" "wineserver -k" "$(eval_gettext 'Be careful! This will kill install process. If it is not finished, you will have to reinstall $SOFTNAME')"
	else
		POL_SetupWindow_wait "$message" "$TITLE"
	fi
	wineserver -w || POL_SetupWindow_message "$(eval_gettext 'Press next only when the installation process is finished')" "$TITLE"
	[ "$forceInput" = "true" ] && POL_SetupWindow_message "$(eval_gettext 'Press next only when the installation process is finished')" "$TITLE"
}



POL_Wine_reboot ()
{
	# Simulate windows reboot
	POL_SetupWindow_wait_next_signal "$(eval_gettext 'Please wait while $APPLICATION_TITLE is simulating a Windows reboot')" "Wine"
	POL_Wine wineboot
}
POL_Wine_GetPrefixFromPath ()
{
	# Return wineprefix from path
	# Usage POL_Wine_GetPrefixFromPath [Exe file]
	local p="$1"
	p="${p#*/wineprefix/}"
	p="${p%%/*}"
	echo "$p"
}
